/**
 * 个人资料设置工具
 * 提供 OneBot 平台的机器人资料修改功能
 */

import { z } from 'zod'
import { StructuredTool } from '@langchain/core/tools'
import type { Context } from 'koishi'
import type { LogFn } from '../../../types'
import { ensureOneBotSession, callOneBotAPI } from '../api'
import { getSession } from '../../chatluna/tools/types'

export interface ProfileToolDeps {
    ctx: Context
    toolName: string
    log?: LogFn
}

const genders: Record<string, string> = { unknown: '0', male: '1', female: '2' }

export function createSetProfileTool(deps: ProfileToolDeps) {
    const { toolName, log } = deps

    // @ts-expect-error - Type instantiation depth issue with zod + StructuredTool
    return new (class extends StructuredTool {
        name = toolName || 'set_self_profile'
        description = "Update the bot's own QQ profile (nickname, signature, gender)."
        schema = z.object({
            nickname: z
                .string()
                .min(1, 'nickname is required')
                .describe('The new nickname for the bot.'),
            signature: z.string().optional().describe('Optional: the new personal signature.'),
            gender: z
                .enum(['unknown', 'male', 'female'])
                .optional()
                .describe('Optional: the new gender.')
        })

        async _call(
            input: { nickname: string; signature?: string; gender?: 'unknown' | 'male' | 'female' },
            _manager?: unknown,
            runnable?: unknown
        ) {
            try {
                const session = getSession(runnable)
                const { error, internal } = ensureOneBotSession(session)
                if (error) return error

                const payload: Record<string, unknown> = { nickname: input.nickname }
                if (input.signature) payload.personal_note = input.signature
                if (input.gender) payload.sex = genders[input.gender]

                await callOneBotAPI(internal!, 'set_qq_profile', payload, ['setQQProfile'])
                const message = '机器人资料已更新。'
                log?.('info', message)
                return message
            } catch (error) {
                log?.('warn', '修改机器人账户信息失败', error)
                return `修改机器人账户信息失败：${(error as Error).message}`
            }
        }
    })()
}
